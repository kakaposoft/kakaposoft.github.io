<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>応援コード 発行</title>
</head>
<body style="font-family:sans-serif;background:#0f1420;color:white;max-width:720px;margin:24px auto;padding:0 16px;">

<h1>応援コード（publicId）の発行</h1>

<p style="opacity:.9;line-height:1.7;">
  PayPal応援後に表示される <b>取引ID（または注文ID）</b> を入力してください。<br>
  失くした場合も、同じIDを入れれば同じコードを再表示できます。
</p>

<div style="background:#121a2a;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px;">
  <div style="margin-bottom:10px;">
    <label>プラン</label><br>
    <select id="plan" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1020;color:#d7e3ff;">
      <option value="P1M">ライト（300円 / 1か月）</option>
      <option value="P6M">ロング（1200円 / 6か月）</option>
    </select>
  </div>

  <div>
    <label>取引ID / 注文ID</label><br>
    <input id="tx" placeholder="例）1AB23456CD789012E"
      style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1020;color:#d7e3ff;">
  </div>

  <button id="btn"
    style="margin-top:12px;padding:10px 14px;border-radius:12px;border:0;background:#2b5cff;color:white;cursor:pointer;">
    発行する
  </button>

  <p id="msg" style="margin:10px 0 0 0;opacity:.9;"></p>

  <pre id="out" style="display:none;background:#0b1020;border:1px dashed rgba(255,255,255,.25);border-radius:12px;padding:12px;overflow:auto;"></pre>
  <p id="exp" style="display:none;margin:8px 0 0 0;opacity:.8;"></p>
</div>

<p style="margin-top:16px;">
  <a href="./index.html" style="color:#7ec8ff;">← 応援ページに戻る</a>
</p>

<script>
  // ★ここをあなたのWorkers APIに差し替え
  const API_ISSUE = "https://kakapo-api.suzukiby039.workers.dev/issue";

  const planEl = document.getElementById("plan");
  const txEl = document.getElementById("tx");
  const btn = document.getElementById("btn");
  const msg = document.getElementById("msg");
  const out = document.getElementById("out");
  const exp = document.getElementById("exp");

  function fmtDate(ms){
    try{
      const d = new Date(ms);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }catch{ return ""; }
  }

  btn.onclick = async () => {
    out.style.display = "none";
    exp.style.display = "none";
    out.textContent = "";
    exp.textContent = "";

    const txId = (txEl.value || "").trim();
    const plan = planEl.value;

    if (!txId) { msg.textContent = "取引ID / 注文ID を入力してください。"; return; }

    msg.textContent = "発行中…";

    try{
      const r = await fetch(API_ISSUE, {
        method: "POST",
        headers: {"content-type":"application/json"},
        body: JSON.stringify({ txId, plan })
      });

      const j = await r.json().catch(()=> ({}));
      if (!r.ok || !j.ok) {
        msg.textContent = j.error || "発行に失敗しました。";
        return;
      }

      msg.textContent = j.reused ? "以前発行したコードを再表示しました。" : "応援コードを発行しました。";
      out.style.display = "block";
      out.textContent = j.publicId;

      if (j.expiresUtc && j.expiresUtc > 0) {
        exp.style.display = "block";
        exp.textContent = `期限：${fmtDate(j.expiresUtc)} まで`;
      }
    }catch(e){
      msg.textContent = "通信に失敗しました。時間をおいてお試しください。";
    }
  };
</script>

</body>
</html>
