<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kakapo Vision Player 応援ページ</title>

<!-- ✅ hosted-buttons を外して、paypal.Buttons が使えるSDKにする -->
<script src="https://www.paypal.com/sdk/js?client-id=BAAbsSyJAfzyEjp8su9MK95BUzip6ZRVg6IE6zVkGrUMv6YoOcOj0RAo2M-JZmLvcst8hk_14zvvzIOIj8&currency=JPY&disable-funding=venmo"></script>
</head>

<body style="font-family:sans-serif;background:#0f1420;color:white;max-width:720px;margin:24px auto;padding:0 16px;line-height:1.7;">

<h1>Kakapo Vision Player 応援ページ</h1>

<!-- ===== 最重要：誤解防止 ===== -->
<div style="background:#1a2238;border:2px solid #ffb74d;border-radius:10px;padding:14px;margin-bottom:18px;">
  <b style="font-size:16px;">※ これは「購入」ではありません</b><br>
  本ページはソフトの販売ではなく、<b>開発への任意の応援（寄付）</b>です。<br>
  アプリの基本機能は、応援なしでも利用できます。
</div>

<p style="opacity:0.92;">
  もし「いいね」と思っていただけたら、開発の応援をしていただけると嬉しいです。<br>
  応援後、発行ページで「応援コード（ライセンス）」を受け取れます。
</p>

<!-- ===== 特典説明（誤解を防ぐ） ===== -->
<div style="background:#121a2a;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:14px;margin:16px 0;">
  <h2 style="margin-top:0;">応援すると</h2>
  <ul style="padding-left:18px;">
    <li>アプリ内の「応援モード（お礼機能）」が利用できます</li>
    <li>内容はプランによらず同じで、期間のみ異なります</li>
  </ul>
  <p style="font-size:13px;opacity:0.8;margin:8px 0 0 0;">
    ※ 特典はお礼機能であり、購入商品ではありません。
  </p>
</div>

<!-- ===== 同意ブロック（最重要） ===== -->
<div style="background:#1a2238;border:1px solid rgba(255,255,255,0.25);border-radius:10px;padding:14px;margin:18px 0;">
  <h3 style="margin-top:0;">重要事項（必ずご確認ください）</h3>

  <p style="font-size:13px;opacity:0.9;">
    ・本支援は商品の購入ではなく、任意の寄付です。<br>
    ・返金、補償、サポート、個別対応は行っておりません。<br>
    ・応援特典はお礼として提供するもので、すべての環境での動作を保証するものではありません。<br>
    ・設定および利用は利用者ご自身の責任で行ってください。<br>
    ・環境差異、操作方法、知識不足、通信状況等により利用できない場合でも対応は行いません。<br>
    ・本ソフトは個人開発です。
  </p>

  <label style="display:flex;gap:8px;margin-top:10px;font-weight:bold;">
    <input type="checkbox" id="agreeCheck">
    <span>上記内容を理解し、同意します</span>
  </label>
</div>

<h2>応援方法（PayPal）</h2>
<p style="font-size:14px;opacity:0.9;">
  同意チェックを入れると決済へ進めます。
</p>

<!-- orderId 表示 -->
<div id="orderInfo" style="display:none;background:#0b1020;border:1px dashed rgba(255,255,255,0.25);border-radius:10px;padding:12px;margin:16px 0;">
  <div style="font-weight:bold;margin-bottom:6px;">オーダーID（控えてください）</div>
  <div id="orderIdText" style="font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;word-break:break-all;"></div>
  <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
    <button id="copyOrderBtn" style="padding:8px 10px;border-radius:8px;border:0;cursor:pointer;">コピー</button>
    <a id="goIssueLink" href="./issue.html" style="color:#7ec8ff;font-weight:bold;text-decoration:none;align-self:center;">
      発行ページへ進む →
    </a>
  </div>
  <div style="font-size:12px;opacity:0.8;margin-top:8px;">
    ※ 反映まで数分かかる場合があります。<br>
    ※ 同じオーダーIDで再発行できます。
  </div>
</div>

<!-- エラー/案内表示 -->
<div id="msg" style="display:none;background:#121a2a;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px;margin:12px 0;opacity:0.95;"></div>

<div style="background:#121a2a;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px;margin-bottom:14px;">
  <h3>ライト（1か月） 300円</h3>
  <div id="pp-1m"></div>
</div>

<div style="background:#121a2a;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px;">
  <h3>ロング（6か月） 1200円</h3>
  <div id="pp-6m"></div>
</div>

<hr style="border:0;border-top:1px solid rgba(255,255,255,0.15);margin:24px 0;">

<h2>応援コードの受け取り（簡単3ステップ）</h2>
<ol>
  <li>PayPalで応援する</li>
  <li>表示される「オーダーID」を控える</li>
  <li><a href="./issue.html" style="color:#7ec8ff;font-weight:bold;">発行ページ</a>で入力する</li>
</ol>

<p style="opacity:0.9;">活動状況はこちら：</p>
<p>
  <a href="https://www.youtube.com/@sekiseikakapo" target="_blank" rel="noopener" style="color:#7ec8ff">
    YouTubeチャンネルを見る
  </a>
</p>

<script>
const API_BASE = "https://kakapo-api.suzukiby039.workers.dev";

function showMsg(html) {
  const el = document.getElementById("msg");
  el.style.display = "block";
  el.innerHTML = html;
}
function hideMsg() {
  const el = document.getElementById("msg");
  el.style.display = "none";
  el.innerHTML = "";
}

function requireAgree() {
  const box = document.getElementById("agreeCheck");
  if (!box || !box.checked) {
    alert("支援前に重要事項への同意が必要です。");
    return false;
  }
  return true;
}

function showOrderId(orderId, plan){
  const wrap = document.getElementById("orderInfo");
  const text = document.getElementById("orderIdText");
  const copyBtn = document.getElementById("copyOrderBtn");
  const goLink = document.getElementById("goIssueLink");

  text.textContent = orderId;
  wrap.style.display = "block";

  copyBtn.onclick = async () => {
    try {
      await navigator.clipboard.writeText(orderId);
      alert("オーダーIDをコピーしました。");
    } catch {
      prompt("コピーできない場合は手動でコピーしてください:", orderId);
    }
  };

  goLink.href = `./issue.html?orderId=${encodeURIComponent(orderId)}&plan=${encodeURIComponent(plan)}`;
}

async function createOrderOnWorker(plan){
  const r = await fetch(`${API_BASE}/paypal/create-order`, {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ plan })
  });

  const j = await r.json().catch(() => ({}));
  if (!r.ok || !j.ok || !j.orderId) {
    throw new Error(j.error || `create-order failed (HTTP ${r.status})`);
  }
  return j.orderId;
}

function mountButton(selector, plan) {
  paypal.Buttons({
    style: { layout: "vertical" },

    createOrder: async () => {
      hideMsg();
      if (!requireAgree()) throw new Error("not agreed");

      try {
        const orderId = await createOrderOnWorker(plan);
        showOrderId(orderId, plan);
        return orderId;
      } catch (e) {
        console.error(e);
        showMsg("オーダー作成に失敗しました。<br>時間をおいて再試行してください。");
        throw e;
      }
    },

    onApprove: async (data) => {
      const orderId = data.orderID;
      showOrderId(orderId, plan);
      showMsg("応援ありがとうございます！<br>上に表示された <b>オーダーID</b> を発行ページで入力してください。");
    },

    onError: (err) => {
      console.error(err);
      showMsg("PayPal処理でエラーが発生しました。<br>時間をおいて再試行してください。");
    }
  }).render(selector);
}

(function boot(){
  if (!window.paypal || !paypal.Buttons) {
    showMsg("PayPalボタンの読み込みに失敗しました。<br>広告ブロッカー等を一時OFFにして再読み込みしてください。");
    return;
  }
  mountButton("#pp-1m", "P1M");
  mountButton("#pp-6m", "P6M");
})();
</script>

</body>
</html>
